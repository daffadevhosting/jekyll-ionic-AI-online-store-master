                      <div id="desktop-chat-panel" class="hidden lg:flex w-96 border-l border-gray-200 bg-white flex-col h-full" >
                            <div class="p-1 border-b border-gray-200 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="rounded-full h-10 mr-2">
                                    <div>
                                        <h5 class="font-semibold text-gray-900">L Y –Ø A Assistant</h5>
                                            <span id="ai-active-time">üïõÔ∏èActive --:--</span>
                                            <span id="ai-online-indicator" class="ml-2 hidden">üü¢ Online</span>
                                    </div>
                                  <ion-buttons>
                                      <ion-button id="clear-chat-desktop" color="danger">
                                          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                      </ion-button>
                                  </ion-buttons>
                                </div>
                            </div>
                            <div id="chat-messages-desktop" class="flex-1 overflow-y-auto py-2 px-4 space-y-4 scrollbar-hide">
                                <!-- Pesan akan dimuat secara dinamis oleh JS -->
                            </div>
                            <div class="p-4 pt-0 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                                <small id="footer" class="text-xs text-gray-500">{{site.author}}</small>
                                <div class="relative flex items-center">
                                    <input id="chat-input-desktop" type="text" placeholder="Tanyakan apapun..." class="w-full pl-4 pr-12 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                  <ion-buttons>
                                    <ion-button id="chat-send-btn-desktop" fill="clear" class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-500">
                                        <ion-icon slot="icon-only" name="send"></ion-icon>
                                    </ion-button>
                                  </ion-buttons>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Chat Modal (dalam ion-modal) -->
                        <ion-modal id="mobile-chat-modal" class="h-full">
                            <ion-header>
                                <ion-toolbar class="text-gray-700 px-4">
                                    <ion-buttons slot="start">
                                        <ion-button onclick="dismissModal('mobile-chat-modal')">
                                            <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
                                        </ion-button>
                                    </ion-buttons>
                                    <ion-title>L Y –Ø A Assistant</ion-title>
                                    <ion-buttons slot="end">
                                        <!-- NEW: Delete Chat History button for Mobile -->
                                        <ion-button id="clear-chat-mobile" fill="clear" color="danger">
                                            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                        </ion-button>
                                    </ion-buttons>
                                </ion-toolbar>
                            </ion-header>
                            <ion-content class="ion-padding bg-gray-50">
                                <!-- Chat Messages Mobile -->
                                <div id="chat-messages-mobile" class="h-full flex flex-col space-y-4 py-2 px-1 scrollbar-hide overflow-y-auto">
                                    <!-- Pesan akan dimuat secara dinamis oleh JS -->
                                </div>
                            </ion-content>
                            <ion-footer class="ion-no-border bg-white p-4">
                                <div class="relative flex items-center">
                                    <input id="chat-input-mobile" type="text" placeholder="Tanyakan apapun..." class="w-full pl-4 pr-12 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <ion-buttons>
                                        <ion-button id="chat-send-btn-mobile" fill="clear" class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-500">
                                            <ion-icon slot="icon-only" name="send"></ion-icon>
                                        </ion-button>
                                    </ion-buttons>
                                </div>
                            </ion-footer>
                        </ion-modal>

<script type="module">
// --- DOM Elements ---
const chatMessagesDesktop = document.getElementById('chat-messages-desktop');
const chatInputDesktop = document.getElementById('chat-input-desktop');
const chatSendBtnDesktop = document.getElementById('chat-send-btn-desktop');
const clearChatDesktopBtn = document.getElementById('clear-chat-desktop');

const mobileChatModal = document.getElementById('mobile-chat-modal');
const openMobileChatBtn = document.getElementById('open-mobile-chat');
const chatMessagesMobile = document.getElementById('chat-messages-mobile');
const chatInputMobile = document.getElementById('chat-input-mobile');
const chatSendBtnMobile = document.getElementById('chat-send-btn-mobile');
const clearChatMobileBtn = document.getElementById('clear-chat-mobile');

// NEW: Elements for real-time status
const aiActiveTimeElement = document.getElementById('ai-active-time');
const aiOnlineIndicatorElement = document.getElementById('ai-online-indicator');


let currentUserId = null;

// --- Utils ---
/**
 * Mencari dan mem-parsing array JSON atau objek JSON dari dalam sebuah string teks.
 * @param {string} text - Teks respons dari AI.
 * @returns {{parsed: Array|Object|null, remaining: string}} Objek berisi data JSON yang sudah diparsing dan sisa teks.
 */
function findJsonInText(text) {
  const jsonRegex = /(\[[^\]]*\]|\{[^}]*\})/;
  const match = text.match(jsonRegex);

  if (match) {
    const jsonPart = match[0];
    try {
      const parsed = JSON.parse(jsonPart);
      const remaining = text.replace(jsonPart, '').trim();
      return { parsed, remaining };
    } catch (e) {
      console.warn("Gagal parsing JSON dari respons AI:", e);
    }
  }
  return { parsed: null, remaining: text };
}


// --- Core Chat Logic ---
/**
 * Menampilkan pesan di jendela chat.
 * @param {string} text - Isi pesan.
 * @param {'user' | 'ai'} sender - Pengirim pesan.
 * @param {HTMLElement} targetChatMessages - Elemen kontainer chat.
 * @param {boolean} isHistorical - Menandakan apakah pesan ini dari riwayat (tidak perlu scroll ke bawah otomatis)
 */
function appendMessage(text, sender, targetChatMessages, isHistorical = false) {
  if (text === null || text === undefined || String(text).trim() === '') {
      console.warn(`appendMessage received invalid text input for sender ${sender}:`, text);
      return;
  }

  const wrapper = document.createElement('div');
  wrapper.className = `flex items-start mb-4 ${sender === 'user' ? 'justify-end' : ''}`;

  const parsedText = marked.parse(String(text));
  const content = (sender === 'ai')
    ? DOMPurify.sanitize(parsedText)
    : `<p class="text-sm">${DOMPurify.sanitize(text)}</p>`;

  if (sender === 'ai') {
    wrapper.innerHTML = `
      <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="h-8 w-8 rounded-full mt-1 flex-shrink-0">
      <div class="ml-3 max-w-sm">
        <div class="p-3 rounded-lg chat-bubble-ai text-sm bg-white shadow">${content}</div>
      </div>
    `;
  } else {
    wrapper.innerHTML = `
      <div class="mr-3 max-w-sm">
        <div class="p-3 rounded-lg chat-bubble-user text-sm bg-purple-100">${content}</div>
      </div>
    `;
  }

  targetChatMessages.appendChild(wrapper);
  if (!isHistorical) {
      // NEW: Periksa apakah ini modal chat mobile dan gulirkan ion-content
      if (targetChatMessages === chatMessagesMobile) {
          // Cari elemen ion-content di dalam modal chat mobile
          const ionContentEl = mobileChatModal.querySelector('ion-content');
          if (ionContentEl && typeof ionContentEl.getScrollElement === 'function') {
              ionContentEl.getScrollElement().then(scrollEl => {
                  scrollEl.scrollTop = scrollEl.scrollHeight;
              }).catch(e => console.error("Error getting scroll element for mobile chat:", e));
          } else {
              // Fallback jika ion-content tidak ditemukan atau getScrollElement tidak tersedia
              targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
          }
      } else {
          // Untuk pesan chat desktop atau scroller div standar lainnya
          targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
      }
    }
}

/**
 * Menampilkan kartu produk di jendela chat.
 * @param {object} product - Objek produk.
 * @param {HTMLElement} targetChatMessages - Elemen kontainer chat.
 */
function appendProductCard(product, targetChatMessages) {
  const wrapper = document.createElement("div");
  wrapper.className = "flex items-start mb-4";

  wrapper.innerHTML = `
    <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="h-8 w-8 rounded-full mt-1 flex-shrink-0">
    <div class="ml-3">
      <div class="bg-gray-100 p-3 rounded-lg max-w-xs shadow-md border border-gray-200">
        <div class="space-y-2">
          <img src="${product.image}" alt="${product.title}" class="w-full h-auto rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/400x300/E0E0E0/333333?text=Gambar+Error';">
          <h4 class="font-semibold text-base">${product.title}</h4>
          <div class="text-sm">
            ${product.price ? `<span class="text-gray-500">Harga: <del>Rp ${product.price}</del></span><br>` : ''}
            <strong class="text-purple-600 text-lg">Rp ${product.discount}</strong>
          </div>
          <p class="text-xs font-medium ${product.stok?.toLowerCase() === 'tersedia' ? 'text-green-600' : 'text-red-600'}">${product.stok || 'Stok tidak diketahui'}</p>
          <ion-button onclick="handleProductClickFromChat('${encodeURIComponent(JSON.stringify(product))}')" color="primary" fill="solid" class="w-full mt-2">
            Lihat Detail & Warna
          </ion-button>
        </div>
      </div>
    </div>
  `;

  targetChatMessages.appendChild(wrapper);
  targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
}

window.handleProductClickFromChat = async function(encodedProduct) {
    const product = JSON.parse(decodeURIComponent(encodedProduct));

    const newProductDetailModal = document.createElement('ion-modal');
    newProductDetailModal.id = `product-detail-modal-${product.id || Date.now()}`;
    newProductDetailModal.innerHTML = `
        <ion-header>
            <ion-toolbar class="text-gray-700 px-4">
                <ion-title>${product.title}</ion-title>
                <ion-buttons slot="end">
                    <ion-button onclick="document.getElementById('${newProductDetailModal.id}').dismiss()">Tutup</ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <img src="${product.image}" alt="${product.title}" class="w-full h-64 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/400x300/E0E0E0/333333?text=Gambar+Tidak+Tersedia';">
            <h2 class="text-xl font-bold mb-2">${product.title}</h2>
            ${product.price ? `<p class="text-gray-500 line-through">Harga Awal: Rp ${product.price}</p>` : ''}
            <p class="text-purple-600 text-2xl font-bold mb-4">Rp ${product.discount}</p>
            <p class="text-sm mb-4">${product.description || 'Tidak ada deskripsi rinci untuk produk ini.'}</p>

            ${product.stok ? `<ion-chip class="px-4" color="${product.stok === 'Tersedia' ? 'success' : 'danger'}"><ion-label>${product.stok}</ion-label></ion-chip>` : ''}

            ${(product.styles && product.styles.length > 0) ? `
                <div class="mt-4">
                    <h3 class="font-semibold text-md mb-2">Pilihan Warna:</h3>
                    <div class="flex gap-2">
                        ${product.styles.map(style => `
                            <span class="w-8 h-8 rounded-full border border-gray-300" title="${style.name}" style="background-color: ${style.color}"></span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <ion-button expand="block" class="mt-6" href="https://wa.me/6281234567890?text=Saya tertarik beli ${encodeURIComponent(product.title)}" target="_blank">
                Beli Sekarang via WhatsApp
                <ion-icon slot="end" name="logo-whatsapp"></ion-icon>
            </ion-button>
        </ion-content>
    `;

    document.body.appendChild(newProductDetailModal);
    await newProductDetailModal.present();

    newProductDetailModal.addEventListener('ionModalDidDismiss', () => {
        newProductDetailModal.remove();
    });
}

function showTypingIndicator(targetChatMessages) {
  const typing = document.createElement('div');
  typing.id = 'typing-indicator';
  typing.className = 'flex items-start mb-4';
  typing.innerHTML = `
    <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="h-8 w-8 rounded-full mt-1 flex-shrink-0">
    <div class="ml-3">
      <div class="bg-white p-3 rounded-lg chat-bubble-ai shadow">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
      </div>
    </div>
  `;
  targetChatMessages.appendChild(typing);
  targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
}

function hideTypingIndicator(targetChatMessages) {
  const indicator = targetChatMessages.querySelector('#typing-indicator');
  if (indicator) indicator.remove();
}

/**
 * Fungsi utama untuk memanggil API AI.
 * @param {string} message - Pesan dari user (bisa string biasa atau JSON yang di-string-kan).
 * @param {Array<Object>} cartItems - Item-item yang saat ini ada di simpleCart.
 * @param {string} userId - ID unik pengguna.
 * @returns {Promise<string>} Respons teks dari AI.
 */
async function callGemini(message, cartItems, userId) {
  try {
    const response = await fetch("https://gemini.sendaljepit.workers.dev/ai-assistant", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: message, cartItems: cartItems, userId: userId })
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.error || 'Terjadi kesalahan pada server.');
    }

    // NEW: Show online indicator if API call is successful
    if (aiOnlineIndicatorElement) {
        aiOnlineIndicatorElement.classList.remove('hidden');
    }

    return data.reply;
  } catch (error) {
    console.error("AI error:", error);
    // NEW: Hide online indicator if API call fails
    if (aiOnlineIndicatorElement) {
        aiOnlineIndicatorElement.classList.add('hidden');
    }
    return error.message || "Waduh, koneksiku lagi bermasalah nih. Coba lagi nanti ya! üòî";
  }
}

/**
 * Memproses aksi keranjang yang dikirim oleh AI.
 * @param {object} actionData - Objek JSON yang berisi detail aksi keranjang.
 * @returns {boolean} True jika ada redirect, false jika tidak.
 */
function processAiCartAction(actionData) {
    if (typeof simpleCart === 'undefined') {
        console.error("simpleCart is not defined. Make sure simpleCart.html is loaded.");
        return false;
    }

    switch (actionData.action) {
        case 'addToCart':
            if (actionData.productName && actionData.price && actionData.quantity) {
                simpleCart.add({
                    name: actionData.productName,
                    price: actionData.price,
                    quantity: actionData.quantity,
                    thumb: actionData.image || 'https://placehold.co/50x50/E0E0E0/333333?text=NoImg',
                    warna: actionData.warna || '-',
                    ukuran: actionData.ukuran || '-',
                    berat: actionData.berat || 0
                });
            } else {
                console.warn("addToCart: Missing product details", actionData);
            }
            break;

        case 'removeFromCart':
            if (actionData.productName) {
                const itemsToRemove = simpleCart.find({ name: actionData.productName });
                if (itemsToRemove.length > 0) {
                    itemsToRemove.forEach(item => item.remove());
                } else {
                    console.warn(`removeFromCart: ${actionData.productName} not found.`);
                }
            } else {
                console.warn("removeFromCart: Missing product name.");
            }
            break;

        case 'updateCartQuantity':
            if (actionData.productName && actionData.quantity !== undefined) {
                const itemToUpdate = simpleCart.find({ name: actionData.productName });
                if (itemToUpdate.length > 0) {
                    itemToUpdate[0].quantity(actionData.quantity);
                } else {
                    console.warn(`updateCartQuantity: ${actionData.productName} not found.`);
                }
            } else {
                console.warn("updateCartQuantity: Missing product name or quantity.");
            }
            break;

        case 'emptyCart':
            simpleCart.empty();
            break;

        case 'viewCart':
            break;
            
        case 'checkout':
            if (actionData.redirectUrl) {
                window.location.href = actionData.redirectUrl;
                return true; 
            } else {
                console.warn("Checkout action: Missing redirect URL.");
            }
            break;

        default:
            console.warn("Unknown cart action:", actionData.action);
            break;
    }
    simpleCart.update();
    return false; 
}


/**
 * Meng-handle pengiriman pesan dari user.
 */
async function handleChatSubmit(chatInput, chatSendBtn, targetChatMessages) {
  const userMessage = chatInput.value.trim();
  if (!userMessage) return;

  chatInput.disabled = true;
  chatSendBtn.disabled = true;

  appendMessage(userMessage, 'user', targetChatMessages);
  chatInput.value = '';
  showTypingIndicator(targetChatMessages);

  const currentCartItems = simpleCart.items().map(item => ({
      id: item.id(),
      name: item.get('name'),
      quantity: item.quantity(),
      price: item.price(),
      image: item.get('thumb'),
      warna: item.get('warna'),
      ukuran: item.get('ukuran'),
      berat: item.get('berat')
  }));

  const aiResponse = await callGemini(userMessage, currentCartItems, currentUserId);

  hideTypingIndicator(targetChatMessages);

  const { parsed, remaining: cleanResponse } = findJsonInText(aiResponse);

  let redirected = false;
  if (parsed && Array.isArray(parsed)) {
    parsed.forEach(prod => appendProductCard(prod, targetChatMessages));
  }
  else if (parsed && typeof parsed === 'object' && parsed.action) {
      redirected = processAiCartAction(parsed); 
  }

  if (!redirected && cleanResponse) {
    appendMessage(cleanResponse, 'ai', targetChatMessages);
  } else if (!redirected) { 
    appendMessage("Maaf, ada masalah dalam merespons. Bisa ulangi?", 'ai', targetChatMessages);
  }


  chatInput.disabled = false;
  chatSendBtn.disabled = false;
  chatInput.focus();
}

/**
 * Fungsi untuk meminta detail produk.
 */
async function requestProductDetail(product, targetChatMessages) {
    appendMessage(`Boleh lihat detail untuk ${product.title}?`, 'user', targetChatMessages);
    showTypingIndicator(targetChatMessages);

    const payloadString = JSON.stringify({
        type: "product_detail",
        data: product
    });

    const currentCartItems = simpleCart.items().map(item => ({
        id: item.id(),
        name: item.get('name'),
        quantity: item.quantity(), 
        price: item.price(),
        image: item.get('thumb'),
        warna: item.get('warna'),
        ukuran: item.get('ukuran'),
        berat: item.get('berat')
    }));

    const aiResponse = await callGemini(payloadString, currentCartItems, currentUserId);

    hideTypingIndicator(targetChatMessages);

    const { parsed, remaining } = findJsonInText(aiResponse);
    let redirected = false;
    if (parsed && Array.isArray(parsed)) {
        parsed.forEach(p => appendProductCard(p, targetChatMessages));
    }
    else if (parsed && typeof parsed === 'object' && parsed.action) {
        redirected = processAiCartAction(parsed);
    }
    if (!redirected && remaining) {
        appendMessage(remaining, 'ai', targetChatMessages);
    } else if (!redirected) {
         appendMessage("Maaf, ada masalah dalam merespons detail produk. Bisa ulangi?", 'ai', targetChatMessages);
    }
}

/**
 * Fungsi untuk menghasilkan atau mengambil User ID dari localStorage.
 * @returns {string} User ID.
 */
function getOrCreateUserId() {
    let userId = localStorage.getItem('lyra_user_id');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('lyra_user_id', userId);
    }
    return userId;
}

/**
 * Fungsi untuk memuat riwayat chat dari backend (KV).
 * @param {string} userId - ID pengguna.
 * @param {HTMLElement} desktopChatMessages - Elemen chat desktop.
 * @param {HTMLElement} mobileChatMessages - Elemen chat mobile.
 */
async function loadChatHistory(userId, desktopChatMessages, mobileChatMessages) {
    desktopChatMessages.innerHTML = '';
    mobileChatMessages.innerHTML = '';

    const defaultWelcomeMessage = "Hai! Saya L Y –Ø A, asisten AI toko online ini. Tanyakan apa saja tentang produk kami! ü§ó";
    let historyLoaded = false;

    try {
        const response = await fetch(`https://gemini.sendaljepit.workers.dev/chat-history?userId=${userId}`);
        const data = await response.json();

        if (!response.ok) {
            console.error("Failed to load chat history:", data.error);
        } else if (data.history && data.history.length > 0) {
            data.history.forEach(entry => {
                let textToDisplay = entry.text;
                if (entry.role === 'ai') {
                    const { remaining } = findJsonInText(entry.text);
                    textToDisplay = remaining;
                }
                appendMessage(textToDisplay, entry.role, desktopChatMessages, true);
                appendMessage(textToDisplay, entry.role, mobileChatMessages, true);
            });
            desktopChatMessages.scrollTop = desktopChatMessages.scrollHeight;
            mobileChatMessages.scrollTop = mobileChatMessages.scrollHeight;
            historyLoaded = true;
        }
    } catch (error) {
        console.error("Error fetching chat history:", error);
    }

    if (!historyLoaded) {
        appendMessage(defaultWelcomeMessage, 'ai', desktopChatMessages, true);
        appendMessage(defaultWelcomeMessage, 'ai', mobileChatMessages, true);
    }
}

/**
 * Fungsi untuk menghapus riwayat chat.
 */
async function clearChatHistory(desktopChatMessages, mobileChatMessages) {
    if (!currentUserId) {
        console.warn("No user ID found, cannot clear chat history.");
        return;
    }

    // Menggunakan document.createElement untuk membuat Ionic Alert secara dinamis
    const alert = document.createElement('ion-alert');
    alert.header = 'Konfirmasi';
    alert.message = 'Apakah Anda yakin ingin menghapus seluruh riwayat chat?';
    alert.buttons = [
        {
            text: 'Batal',
            role: 'cancel',
            cssClass: 'secondary',
            handler: () => {
                alert.remove();
            }
        },
        {
            text: 'Hapus',
            handler: async () => {
                try {
                    const response = await fetch(`https://gemini.sendaljepit.workers.dev/chat-history?userId=${currentUserId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Gagal menghapus riwayat chat.');
                    }

                    desktopChatMessages.innerHTML = '';
                    mobileChatMessages.innerHTML = '';

                    const defaultWelcomeMessage = "Hai! Saya L Y –Ø A, asisten AI toko online ini. Tanyakan apa saja tentang produk kami! ü§ó";
                    appendMessage(defaultWelcomeMessage, 'ai', desktopChatMessages);
                    appendMessage(defaultWelcomeMessage, 'ai', mobileChatMessages);

                    const toast = document.createElement('ion-toast');
                    toast.message = 'Riwayat chat berhasil dihapus!';
                    toast.duration = 2000;
                    toast.color = 'success';
                    document.body.appendChild(toast);
                    await toast.present();
                    toast.onDidDismiss(() => toast.remove());

                } catch (error) {
                    console.error("Error clearing chat history:", error);
                    const toast = document.createElement('ion-toast');
                    toast.message = `Error: ${error.message}`;
                    toast.duration = 3000;
                    toast.color = 'danger';
                    document.body.appendChild(toast);
                    await toast.present();
                    toast.onDidDismiss(() => toast.remove());
                } finally {
                    alert.remove();
                }
            },
        },
    ];
    document.body.appendChild(alert);
    await alert.present();
}

// --- NEW: Real-time Clock Function ---
function updateAiActiveTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    aiActiveTimeElement.textContent = `üïõÔ∏èActive ${hours}:${minutes}`;
}


// --- Product Listing & Events ---
let allProducts = [];
let showOnlyAvailable = false;

async function renderProducts(keyword = "") {
  const productGrid = document.getElementById('product-grid');
  productGrid.innerHTML = `<div class="w-full flex justify-center py-8"><ion-spinner name="dots"></ion-spinner></div>`;

  try {
    if (!allProducts.length) {
      const res = await fetch("https://as-syariahbordir.github.io/produk.json");
      const data = await res.json();
      allProducts = data.produk;
    }

    const keywordLower = keyword.toLowerCase();
    const filtered = allProducts.filter(p => {
      const matchKeyword = p.title.toLowerCase().includes(keywordLower) || (p.description && p.description.toLowerCase().includes(keywordLower));
      const matchStok = showOnlyAvailable ? p.stok?.toLowerCase() === "tersedia" : true;
      return matchKeyword && matchStok;
    });

    productGrid.innerHTML = '';

    if (filtered.length === 0) {
      productGrid.innerHTML = `<div class="text-center w-full text-gray-500 col-span-full py-8">Produk tidak ditemukan.</div>`;
      return;
    }

    filtered.forEach(product => {
      const card = document.createElement('ion-card');
      card.className = 'transition duration-300 ease-in-out transform shadow-md';

      card.innerHTML = `
        <div class="relative h-68 overflow-hidden">
          <img src="${product.image}" alt="${product.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/E0E0E0/333333?text=Gambar+Tidak+Tersedia';">
        </div>
        <ion-card-header class="p-4">
          <ion-card-title class="text-lg">${product.title}</ion-card-title>
          <ion-card-subtitle class="text-purple-600 font-bold mt-1">Rp ${product.discount}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="flex justify-end-safe items-center">
            <ion-button fill="outline" size="small" color="primary" class="ask-ai-btn">
              <ion-icon name="sparkles-outline" slot="start"></ion-icon>
              Tanya AI
            </ion-button>
          </div>
        </ion-card-content>
      `;

      card.querySelector('.ask-ai-btn').addEventListener('click', () => {
        const targetChatMessages = window.innerWidth < 768 ? chatMessagesMobile : chatMessagesDesktop;

        if (window.innerWidth < 768) {
            mobileChatModal.present();
        }

        requestProductDetail(product, targetChatMessages);
      });

      productGrid.appendChild(card);
    });

  } catch (err) {
    console.error("Gagal fetch produk:", err);
    productGrid.innerHTML = `<div class="w-full text-center text-red-600 py-4 col-span-full">‚ùå Gagal memuat produk.</div>`;
  }
}

// --- Initial Setup & Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
  currentUserId = getOrCreateUserId();
  console.log("User ID:", currentUserId);

  loadChatHistory(currentUserId, chatMessagesDesktop, chatMessagesMobile);

  // NEW: Initialize and update real-time clock
  updateAiActiveTime(); // Initial call
  setInterval(updateAiActiveTime, 1000); // Update every second

  if (window.innerWidth < 768) {
      mobileChatModal.present();
  }

  renderProducts();
});


// modal dissmis
window.dismissModal = (modalId) => {
    const modalToDismiss = document.getElementById(modalId);
        if (modalToDismiss) {
        modalToDismiss.dismiss();
    }
}

// Search
document.getElementById('product-searchbar').addEventListener('ionInput', (e) => renderProducts(e.detail.value));

// Toggle Stok
document.getElementById('toggle-stok').addEventListener('click', (e) => {
  showOnlyAvailable = !showOnlyAvailable;
  e.target.textContent = showOnlyAvailable ? 'Tampilkan Semua Produk' : 'Hanya yang Tersedia';
  renderProducts(document.getElementById('product-searchbar').value);
});

// Events Desktop
chatSendBtnDesktop.addEventListener('click', () => handleChatSubmit(chatInputDesktop, chatSendBtnDesktop, chatMessagesDesktop));
chatInputDesktop.addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleChatSubmit(chatInputDesktop, chatSendBtnDesktop, chatMessagesDesktop);
  }
});
clearChatDesktopBtn.addEventListener('click', () => clearChatHistory(chatMessagesDesktop, chatMessagesMobile));

// Events Mobile
openMobileChatBtn.addEventListener('click', () => mobileChatModal.present());
chatSendBtnMobile.addEventListener('click', () => handleChatSubmit(chatInputMobile, chatSendBtnMobile, chatMessagesMobile));
chatInputMobile.addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleChatSubmit(chatInputMobile, chatSendBtnMobile, chatMessagesMobile);
  }
});
clearChatMobileBtn.addEventListener('click', () => clearChatHistory(chatMessagesDesktop, chatMessagesMobile));
</script>