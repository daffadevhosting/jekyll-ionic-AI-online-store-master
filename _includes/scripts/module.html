    <script type="module">
        // --- DOM Elements ---
        const productGrid = document.getElementById('product-grid');
        
        // Desktop Chat Elements
        const chatMessagesDesktop = document.getElementById('chat-messages-desktop');
        const chatInputDesktop = document.getElementById('chat-input-desktop');
        const chatSendBtnDesktop = document.getElementById('chat-send-btn-desktop');

        // Mobile Chat Elements
        const mobileChatModal = document.getElementById('mobile-chat-modal');
        const openMobileChatBtn = document.getElementById('open-mobile-chat');
        const chatMessagesMobile = document.getElementById('chat-messages-mobile');
        const chatInputMobile = document.getElementById('chat-input-mobile');
        const chatSendBtnMobile = document.getElementById('chat-send-btn-mobile');

        // Product Description Modal Elements
        const descriptionModal = document.getElementById('description-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        // --- Product Data ---
        const products = [
            { name: "Keripik Singkong", price: "25.000", image: "https://sibeunteurgeulis.majalengkakab.go.id/keripik/attachments/gambar_produk/283.png", rating: 4.3, tag: "★ Terjual banyak" },
            { name: "Le Mineral", price: "3.000", image: "https://storage.googleapis.com/eezee-product-images/le-minerale-galon-15l-2qoy_600.png", rating: 4.1, tag: "★ Terjual banyak" },
            { name: "Bubur Mang Oleh", price: "30.000", image: "https://cdn1-production-images-kly.akamaized.net/pYBziE7NNucaHRGuvLNG35rKw3Y=/800x800/smart/filters:quality(75):strip_icc():format(webp)/kly-media-production/medias/4987582/original/065202700_1730448174-Semangkuk_bubur_ayam.__Liputan6.comWikimedia_CommonsAfrogindahood_.jpg", rating: 4.8, tag: "★ Best Seller" },
            { name: "Pizza Hot", price: "120.000", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQAOFAnwGi6K6gF5O9ltqB3whTihGSPOJ1gwuUr7VE0XA&s", rating: 4.5, tag: "★ New Arrival" },
            { name: "Basreng Mahasiswi", price: "10.000", image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR3CQOI_N2ksct-5ydCT87wp_Sbe8n4f1pCBCqmQdxuYy4cBGcbBoTgqXB8&s=10", rating: 4.3, tag: "★ Special Offer" },
            { name: "Kopi Jahe", price: "15.000", image: "https://static.republika.co.id/uploads/member/images/news/230425120157-932.jpeg", rating: 4.6, tag: "★ Favorit" }
        ];

        // --- Gemini API Call Function ---
        async function callGemini(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            // Use __api_key provided by the environment, or an empty string if not defined.
            const apiKey = GEMINI_API; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected response structure:", result);
                    return "Maaf, saya tidak bisa memproses permintaan Anda saat ini.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Maaf, terjadi kesalahan saat menghubungi asisten AI.";
            }
        }

        // --- UI Rendering ---
        function renderProducts() {
            productGrid.innerHTML = '';
            products.forEach(product => {
                const card = document.createElement('ion-card');
                card.className = 'transition duration-300 ease-in-out transform shadow-md';
                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/E0E0E0/333333?text=Gambar+Tidak+Tersedia';"/>
                        <ion-chip class="absolute top-2 right-2">
                            <ion-icon name="star" color="warning"></ion-icon>
                            <ion-label>${product.rating}</ion-label>
                        </ion-chip>
                    </div>
                    <ion-card-header>
                        <ion-card-title class="text-lg">${product.name}</ion-card-title>
                        <ion-card-subtitle class="text-purple-600 font-bold mt-1">Rp ${product.price}</ion-card-subtitle>
                    </ion-card-header>
                    <ion-card-content>
                        <div class="flex justify-between items-center">
                           <span class="text-xs text-gray-500">${product.tag}</span>
                           <ion-button size="small" class="text-gray-700 rounded-full">Add to Cart</ion-button>
                        </div>
                        <ion-button fill="outline" size="small" expand="block" class="mt-2 generate-desc-btn">
                            ✨ Buat Deskripsi
                        </ion-button>
                    </ion-card-content>
                `;
                card.querySelector('.generate-desc-btn').addEventListener('click', () => handleGenerateDescription(product.name));
                productGrid.appendChild(card);
            });
        }

        // --- Chat Functions ---
        function appendMessage(text, sender, targetChatMessages) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''}`;
            
            if (sender === 'ai') {
                messageWrapper.innerHTML = `
                    <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="h-8 w-8 rounded-full mt-1">
                    <div class="ml-3">
                        <div class="p-3 rounded-lg chat-bubble-ai">
                            <p class="text-sm">${text}</p>
                        </div>
                    </div>
                `;
            } else {
                 messageWrapper.innerHTML = `
                    <div class="mr-3">
                        <div class="p-3 rounded-lg chat-bubble-user">
                            <p class="text-sm">${text}</p>
                        </div>
                    </div>
                `;
            }
            targetChatMessages.appendChild(messageWrapper);
            targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
        }
        
        function showTypingIndicator(targetChatMessages) {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'flex items-start';
            typingIndicator.innerHTML = `
                <img src="https://lyra-ai-nine.vercel.app/logo.png" alt="LYRA" class="h-8 w-8 rounded-full mt-1">
                <div class="ml-3">
                    <div class="bg-gray-100 p-3 rounded-lg chat-bubble-ai">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            targetChatMessages.appendChild(typingIndicator);
            targetChatMessages.scrollTop = targetChatMessages.scrollHeight;
        }

        function hideTypingIndicator(targetChatMessages) {
            const indicator = targetChatMessages.querySelector('#typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function handleChatSubmit(chatInput, chatSendBtn, targetChatMessages) {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Disable input and button
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            appendMessage(userMessage, 'user', targetChatMessages);
            chatInput.value = '';
            showTypingIndicator(targetChatMessages);

            const prompt = `Anda adalah LYRA, asisten belanja AI yang ramah dan membantu. Jawab pertanyaan pengguna dengan singkat dan informatif. Pertanyaan: "${userMessage}"`;
            const aiResponse = await callGemini(prompt);
            
            hideTypingIndicator(targetChatMessages);
            appendMessage(aiResponse, 'ai', targetChatMessages);

            // Re-enable input and button
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatInput.focus(); // Keep focus on input after sending
        }

        // --- Modal Functions ---
        async function handleGenerateDescription(productName) {
            descriptionModal.present();
            modalTitle.textContent = `Deskripsi untuk ${productName}`;
            modalContent.innerHTML = '<ion-spinner name="dots"></ion-spinner>';
            
            const prompt = `Buatkan deskripsi produk yang menarik, singkat, dan persuasif untuk dijual secara online. Nama produk: "${productName}". Fokus pada keunggulan dan daya tariknya.`;
            const description = await callGemini(prompt);
            
            modalContent.innerHTML = description.split('\n').join('<br>');
        }

        window.dismissModal = (modalId) => {
            const modalToDismiss = document.getElementById(modalId);
            if (modalToDismiss) {
                modalToDismiss.dismiss();
            }
        }

        // --- Event Listeners ---
        // Desktop Chat
        chatSendBtnDesktop.addEventListener('click', () => handleChatSubmit(chatInputDesktop, chatSendBtnDesktop, chatMessagesDesktop));
        chatInputDesktop.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChatSubmit(chatInputDesktop, chatSendBtnDesktop, chatMessagesDesktop);
            }
        });

        // Mobile Chat
        openMobileChatBtn.addEventListener('click', () => {
            mobileChatModal.present();
        });
        chatSendBtnMobile.addEventListener('click', () => handleChatSubmit(chatInputMobile, chatSendBtnMobile, chatMessagesMobile));
        chatInputMobile.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChatSubmit(chatInputMobile, chatSendBtnMobile, chatMessagesMobile);
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
        });

    </script>
    
    <script nomodule>
        // Fallback for non-module browsers if needed
    </script>